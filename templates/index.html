{% extends "base.html" %}
{% block title %}Enter Time{% endblock %}
{% block content %}
    <nav class="row">
      <dl class="sub-nav">
        <dt>Manage:</dt>
        <dd><a href="/employee">Employees</a></dd>
        <dd><a href="/customer">Customers</a></dd>
        <dd><a href="/client">Clients</a></dd>
        <dd><a href="/project">Projects</a></dd>
        <dd><a href="/task">Tasks</a></dd>
      </dl>
    </nav>

	<div class="row">
		<div class="large-8 columns">
      <button class="small radius calendar" type="button">&nbsp;</button>
      <button class="small radius" type="button" onclick="window.location='/'">Today</button>
			<button class="small radius" type="button" onclick="window.location='/?weekId={{prev_weekId}}'">&lt;</button>
			<button class="small radius" type="button" onclick="window.location='/?weekId={{next_weekId}}'">&gt;</button>
    </div>
    <div class="large-8 columns text-right">
			<h3>{{ rangeTitle }}</h3>
		</div>
    <hr/>
	</div>


  {% load timetracker_extras %}


  <form method="POST" action="/?weekId={{ weekId }}">
    {% csrf_token %}

    <div class="row title-row">
    	<div class="large-2 columns sun-title">{{ sunTitle }}<br/><b>Sun</b></div>
  		<div class="large-2 columns mon-title">{{ monTitle }}<br/><b>Mon</b></div>
  		<div class="large-2 columns tue-title">{{ tueTitle }}<br/><b>Tue</b></div>
  		<div class="large-2 columns wed-title">{{ wedTitle }}<br/><b>Wed</b></div>
  		<div class="large-2 columns thu-title">{{ thuTitle }}<br/><b>Thu</b></div>
  		<div class="large-2 columns fri-title">{{ friTitle }}<br/><b>Fri</b></div>
  		<div class="large-2 columns sat-title">{{ satTitle }}<br/><b>Sat</b></div>
  		<div class="large-2 columns total-title"><br/><b>Total</b></div>
    </div>

    {{ time_entry_formset.management_form }}

    <div class="entry-rows">
      {% for f in time_entry_formset.forms %}
      <div class="entry-row">

        <!-- task name -->
      	<div class="row task-name-row">
      		<div class="large-14 columns">
      			<div class="task-name">{% get_task_name f.taskDefinitionId.value %} {{ f.taskDefinitionId.errors }}</div>
      			<div class="task-description">{% get_task_desc f.taskDefinitionId.value %} {{ f.rowId.errors }}</div>
      		</div>
          <div class="large-2 columns text-right">
            <span class="delete" onclick="deletEntry(this);">[X]</span>
          </div>
          {{ f.taskDefinitionId }}
      		{{ f.rowId }}
      	</div>

        <!-- task hours -->
      	<div class="row hours-row">
      		<div class="large-2 columns sun hours {% if f.sundayHours.errors %}error{% endif %}">
            {{ f.sundayHours }}
            {% if f.sundayHours.errors %}
            <small>{{ f.sundayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns mon hours {% if f.mondayHours.errors %}error{% endif %}">
            {{ f.mondayHours }}
            {% if f.mondayHours.errors %}
            <small>{{ f.mondayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns tue hours {% if f.tuesdayHours.errors %}error{% endif %}">
            {{ f.tuesdayHours }}
            {% if f.tuesdayHours.errors %}
            <small>{{ f.tuesdayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns wed hours {% if f.wednesdayHours.errors %}error{% endif %}">
            {{ f.wednesdayHours }}
            {% if f.wednesdayHours.errors %}
            <small>{{ f.wednesdayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns thu hours {% if f.thursdayHours.errors %}error{% endif %}">
            {{ f.thursdayHours }}
            {% if f.thursdayHours.errors %}
            <small>{{ f.thursdayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns fri hours {% if f.fridayHours.errors %}error{% endif %}">
            {{ f.fridayHours }}
            {% if f.fridayHours.errors %}
            <small>{{ f.fridayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns sat hours {% if f.saturdayHours.errors %}error{% endif %}">
            {{ f.saturdayHours }}
            {% if f.saturdayHours.errors %}
            <small>{{ f.saturdayHours.errors }}</small>
            {% endif %}
          </div>
      		<div class="large-2 columns row-total"></div>
      	</div>

        <!-- task comment -->
      	<div class="row comment-row">
      		<div class="large-14 columns comment {% if f.comment.errors %}error{% endif %}">
  	    		{{ f.comment }}
            {% if f.comment.errors %}
            <small>{{ f.comment.errors }}</small>
            {% endif %}
  	    	</div>
      	</div>
      </div>
      {% endfor %}
    </div>

    <div class="row grand-total-row">
      <div class="large-2 columns sun-total"><span></span></div>
      <div class="large-2 columns mon-total"><span></span></div>
      <div class="large-2 columns tue-total"><span></span></div>
      <div class="large-2 columns wed-total"><span></span></div>
      <div class="large-2 columns thu-total"><span></span></div>
      <div class="large-2 columns fri-total"><span></span></div>
      <div class="large-2 columns sat-total"><span></span></div>
      <div class="large-2 columns grand-total"></div>
    </div>

    <div class="row controls-row">
      <div class="large-11 columns">
        <select id="task-select">
          <option value="">Select a task</option>
          {% for key,value in tasks_map.items %}
          <optgroup label="{{ key }}">
            {% for task in value %}
          <option value="{{ task.id }}">{{ task.name }}</option>
            {% endfor %}
          </optgroup>
          {% endfor %}
        </select>
      </div>
      <div class="large-2 columns"><button class="small radius" type="button" id="add-btn">Add</button></div>
      <div class="large-3 columns text-right">
        <button  class="small radius" type="submit" name="save" onclick="inputDirty = false;" id="save-btn">Save</button>
        <button  class="small radius" type="submit" name="complete" onclick="inputDirty = false;" id="complete-btn">Complete</button>
      </div>
    </div>
  </form>
{% endblock %}

{% block extrabody %}  
  <script>

    $(document).foundation();

    $("#task-select").select2();

    // setup unsaved changes warning
    var inputDirty = false;

    window.onbeforeunload = function() {
      if (inputDirty) {
          return 'You have unsaved changes.';
        }
    };

    $('div.entry-row input[type="text"]').change(function(){
      inputDirty = true;
      $(this).attr('data-dirty', 'true');
    });

    // setup hours entry
    function preventText(event) {
        if ( !(event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 37 || event.keyCode == 39 || event.keyCode == 9 || event.keyCode == 13 || (event.keyCode >= 48 && event.keyCode <= 57 ) || event.keyCode == 110 || (event.keyCode >= 96 && event.keyCode <= 105 ) || (event.keyCode == 190 && $(this).val().indexOf(".") == -1 ))) {
          event.preventDefault();
        }
    }

    $('div.hours input').keydown(preventText);

    // setup totals calculation
  	function updateTotals() {
  		// update totals
  		$('div.hours-row').each(function(){
  			var total = 0;
  			$('div.hours input', this).each(function(){
          var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
  				  total += hours;
          }
  			});
  			$('div.row-total', this).html(total.toFixed(2));
  		});

  		var sunTotal = 0;
  		var grandTotal = 0;
  		$('div.sun.hours input').each(function(){
  			  var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            sunTotal += hours;
          }
  		});
  		$('div.sun-total span').html(sunTotal);
  		grandTotal += sunTotal;

  		var monTotal = 0;
  		$('div.mon.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            monTotal += hours;
          } 
  		});
  		$('div.mon-total span').html(monTotal);
  		grandTotal += monTotal;

  		var tueTotal = 0;
  		$('div.tue.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            tueTotal += hours;
          } 
  		});
  		$('div.tue-total span').html(tueTotal);
  		grandTotal += tueTotal;

  		var wedTotal = 0;
  		$('div.wed.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            wedTotal += hours;
          } 
  		});
  		$('div.wed-total span').html(wedTotal);
  		grandTotal += wedTotal;

  		var thuTotal = 0;
  		$('div.thu.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            thuTotal += hours;
          }
  		});
  		$('div.thu-total span').html(thuTotal);
  		grandTotal += thuTotal;

  		var friTotal = 0;
  		$('div.fri.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            friTotal += hours;
          }
  		});
  		$('div.fri-total span').html(friTotal);
  		grandTotal += friTotal;

  		var satTotal = 0;
  		$('div.sat.hours input').each(function(){
  			var hours = parseFloat($(this).val());
          if (!isNaN(hours)) {
            satTotal += hours;
          }
  		});
  		$('div.sat-total span').html(satTotal);
  		grandTotal += satTotal;

  		$('div.grand-total').html(grandTotal.toFixed(2));
  	}

  	updateTotals();

  	$('div.hours input').keyup(updateTotals);


    // setup adding of rows
    var formCount = $('div.entry-row').length;

    $('#add-btn').click(function(){

      var taskDefinitionId = $('#task-select').val();

      if (taskDefinitionId && $.trim(taskDefinitionId).length > 0) {
        var taskDescription = $('#task-select option:selected').parent().attr('label');
        var taskName = $('#task-select option:selected').text();

        var data = {
          'taskName': taskName,
          'taskDescription': taskDescription,
          'taskDefinitionId': taskDefinitionId,
          'formId': formCount
        };

        $('div.entry-rows').append(timeEntryRow.render(data));

        inputDirty = true;

        $('div.hours input').unbind('keyup', preventText);
        $('div.hours input').keyup(preventText);

        $('div.hours input').unbind('keydown', preventText);
        $('div.hours input').keydown(preventText);

        // set form count to actual count
        $('#id_form-TOTAL_FORMS').val($('div.entry-row').length);

        formCount++;

      }

    });

    // setup removing of rows
    function deletEntry(btn) {
      var entryRow = $(btn).parents('div.entry-row');
      //var taskName = $('div.task-name', entryRow).text();
      if (confirm('Are you sure you want to delete this row?')) {
        console.log('deleting');
        entryRow.remove();

        // set form count to actual count
        $('#id_form-TOTAL_FORMS').val($('div.entry-row').length);

        inputDirty = true;
      }
    }

  </script>
{% endblock %}
