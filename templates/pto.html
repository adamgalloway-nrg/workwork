{% extends "base.html" %}

{% block title %}Manage PTO{% endblock %}

{% block content %}
    <nav class="row">
      <dl class="sub-nav">
        <dt>Manage:</dt>
        <dd><a href="/employee">Employees</a></dd>
        <dd><a href="/customer">Customers</a></dd>
        <dd><a href="/client">Clients</a></dd>
        <dd><a href="/project">Projects</a></dd>
        <dd><a href="/task">Tasks</a></dd>
        <dd class="active"><a href="/pto">PTO</a></dd>
      </dl>
    </nav>


    <section>
      <div class="row">
          <h4>Paid Time Off</h4>
          <button class="small radius" type="button" onclick="window.location='/pto/'">Current</button>
          <button class="small radius" type="button" onclick="window.location='/pto/?year={{prev_year}}'">&lt;</button>
          <button class="small radius" type="button" onclick="window.location='/pto/?year={{next_year}}'">&gt;</button>
      </div>

      <div class="row section-container vertical-tabs" data-section="vertical-tabs">
        {% for key,value in pto_map.items %}
        <section>
          <p class="title" data-section-title><a href="#">{{key.name}}</a></p>
          <div class="content" data-section-content>
            <div class="row">
              <div class="large-16 columns">
                  {% csrf_token %}
                  <table class="large-16">
                    <thead>
                      <tr>
                        <th class="large-14">Name</th>
                        <th class="large-2 text-right">Hours</th>
                      </tr>
                    </thead>

                    <tbody>
                    {% for item in value %}
                      <tr class="item">
                        <td class="large-14">{{ item.task.name }}</td>
                        <td class="large-2 text-right">
                          <input type="text" class="text-right" name="hours" data-id="{{ item.pto.id }}" data-taskdefinitionid="{{ item.pto.taskDefinitionId }}" data-employee="{{ item.pto.employee }}" value="{{ item.pto.hours }}" />
                        </td>
                      </tr>
                    {% endfor %}
                    </tbody>
                  </table>
                  <button type="button" name="save" class="radius small right">Save</button>

              </div>
            </div>
          </div>
        </section>
        {% endfor %}
      </div>

    </section>

{% endblock %}

{% block extrabody %}
    <script>
      // move me to util
      $(document).ajaxSend(function(event, xhr, settings) {
          function getCookie(name) {
              var cookieValue = null;
              if (document.cookie && document.cookie != '') {
                  var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                      var cookie = jQuery.trim(cookies[i]);
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) == (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
          function sameOrigin(url) {
              // url could be relative or scheme relative or absolute
              var host = document.location.host; // host + port
              var protocol = document.location.protocol;
              var sr_origin = '//' + host;
              var origin = protocol + sr_origin;
              // Allow absolute or scheme relative URLs to same origin
              return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                  (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                  // or any other URL that isn't scheme relative or absolute i.e relative.
                  !(/^(\/\/|http:|https:).*/.test(url));
          }
          function safeMethod(method) {
              return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
          }

          if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
              xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
          }
      });

      function preventText(event) {
          if ( !(event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 37 || event.keyCode == 39 || event.keyCode == 9 || event.keyCode == 13 || (event.keyCode >= 48 && event.keyCode <= 57 ) || event.keyCode == 110 || (event.keyCode >= 96 && event.keyCode <= 105 ) || (event.keyCode == 190 && $(this).val().indexOf(".") == -1 ))) {
            event.preventDefault();
          }
      }

      $('input[name="hours"]').keydown(preventText);

      $('button[name="save"]').click(function(event) {
        var target = $(event.currentTarget);
        var data = [];

        $('input[name="hours"]', target.parent()).each(function(){
          var hours = $(this).val();
          var id = $(this).attr('data-id');
          var employee = $(this).attr('data-employee');
          var task = $(this).attr('data-taskdefinitionid');

          data.push({
            id: id,
            taskDefinitionId: task,
            employee: employee,
            hours: hours
          });
        });

        $.ajax({
          url: '/pto/?year={{year}}',
          type: 'POST',
          dataType: 'json',
          data: JSON.stringify(data),
          success: function() {
            alert("Changes saved successfully");
          },
          error: function() {
            alert("An error occured");
          }
        });

      });

    </script>
{% endblock %}